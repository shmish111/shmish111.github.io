<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Load Testing · Continuously Improving</title><meta name="description" content="Load Testing - David Smith"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/shmish111" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Load Testing</h1><div class="post-time">Mar 8, 2016</div><div class="post-content"><p>In a recent project we had built a microservice that would take a request through a RESTful interface, provide a small amount of validation and the place the result on RabbitMQ. For this microservice we had chosen the excellent Yada library to take care of all the HTTP/REST infrastructure for us. The service wouldn’t be used in a particularly intensive way however the team felt that it would be a good idea to push it to see when it falls down and what happens.</p>
<p>We decided to use clj-gatling for our load testing. This is a clojure test runner which is designed primarily for hitting servers with thousands of requests in parallel and producing nice reports about what happened. Since we had already written integration tests to check the functionality of the service, it was simply a matter of reusing these tests in a slightly modified manner. We would hit the service on a few of the endpoints and check that the appropriate messages were present on the Rabbit queue. I knew that both RabbitMQ and the aleph server that yada uses were designed for high performance so I imagined that we would have to really push things to see any problems, after all, we had already verified that the service worked reliably with the integration tests.</p>
<p>In the first run I decided to hit the service with 1000 requests from 10 ‘users’ in parallel. One of the endpoints was a CSV file upload using and I was suprised to find that some of the messages from this endpoint had not appeared on the queue. My initial reaction was that perhaps there was a small overhead getting messages on to Rabbit and although throughput would be high, I might need to give a bit of time after the test had fired it’s requests to see all the results. However I was suprised to find that the messages were simply not getting put on the Rabbit queue, they were just disappearing. With some old-school <code>prn</code> debugging, it was possible to see that request was getting in to the server but the body was not appearing in my yada handler. This would happen for about 0.5 - 1% of requests which of course we would never have found with our integration tests. Perhaps occasionally we would have a failed Jenkins build but run it again and everything would pass, it would in all probability be put down to something weird on the Jenkins slave and be ignored. We would have lost data in production at some point.</p>
<p>Step 1 was that this made us realise that we should give a 400 response if the body was empty, something we had failed to think about. Next, careful investigation revealed that the library yada was using for finding multipart boudaries was broken. As a side note, this library was a prime candidate for property based testing and it would have revealed this bug. Malcom, the author of yada promptly wrote his own implementation of the Boyer-Moore search algorithm to fix the issue. So we ran the tests again but we saw the same failures! Working with Malcom we found that under certain circumstances, the logic of piecing together the chunks of an uploaded file was incorrect. The issue was fixed and finally the tests passed, we were able to push the service until we finally ran out of file descriptors.</p>
<p>So what did I learn from this experience?</p>
<ol>
<li>Load tests are important, they can test more than just performance.</li>
<li>Generative tests are vital and can find bugs that would have resulted in loss of revenue.</li>
<li>Even wearing a QA hat, we can miss failure scenarios that should be planned for and dealt with appropriately (a 400 response in this case).</li>
<li>It’s vital to use libraries that are either battle tested and very mature or that are actively maintained so that bugs can be fixed promptly.</li>
<li>Property based testing should be applied where possible, especially when it comes to algorithm implementations such as the Boyer-Moore search.</li>
</ol>
<p>In the next installment of this series I’m going to talk about test strategy and provide some opinons on what gives best value.</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/03/05/generative-testing/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://shmish111.github.io">David Smith</a>, unless otherwise noted.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-52255315-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>