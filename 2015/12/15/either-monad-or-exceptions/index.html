<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Either monad or exceptions · Continuously Improving</title><meta name="description" content="Either monad or exceptions - David Smith"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/shmish111" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Either monad or exceptions</h1><div class="post-time">Dec 15, 2015</div><div class="post-content"><p><strong>TL;DR</strong> The <code>Either</code> monad from <a href="https://github.com/funcool/cats" target="_blank" rel="external">cats</a> is pretty cool.<br><a id="more"></a><br>Recently I was asked to complete a small test for a job interview in the form of a Clojure program. The idea of the program was to take commands from stdin and use them to mess around with a ‘canvas’, basically a super-primitive graphics program. It occured to me that since part of this would involve parsing and validating commands and displaying any errors, it might be a good opportunity to use the Either monad and see the current state of monad libraries in Clojure.</p>
<p>I have used <a href="https://github.com/clojure/algo.monads" target="_blank" rel="external">algo.monads</a> in the past but looking at the project on github I could see that it hadn’t been updated in more than 11 months. I thought that perhaps there has been some work done in this area since then and I discovered <a href="https://github.com/funcool/cats" target="_blank" rel="external">cats</a>. It has some nice documentation and a nice philosophy so I decided to give it a try.</p>
<p>The program flow is:</p>
<ul>
<li>read-line from the console</li>
<li>split the input by the space character</li>
<li>dispatch the arguments and the current state of the program to a multi-method, based on the first argument</li>
<li>return the new state or a string to display on the console</li>
<li>loop round to read-line again</li>
</ul>
<p>This flow allows me to use pure functions for the multi-method as in the following command which flood-fills an area of the canvas:</p>
<figure class="highlight clj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> valid-number-of-args</span><br><span class="line">  [args n]</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n (<span class="name"><span class="builtin-name">count</span></span> args))</span><br><span class="line">    (<span class="name">right</span> args)</span><br><span class="line">    (<span class="name">left</span> (<span class="name"><span class="builtin-name">str</span></span> <span class="string">"invalid number of arguments, expected "</span> n))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">defmethod</span></span> do-command <span class="string">"F"</span></span><br><span class="line">  [_ state &amp; args]</span><br><span class="line">  (<span class="name">m/mlet</span> [[x y colour] (<span class="name">valid-number-of-args</span> args <span class="number">3</span>)</span><br><span class="line">           pixel (<span class="name">valid-pixel</span> state x y)</span><br><span class="line">           _ (<span class="name">valid-colour</span> colour)]</span><br><span class="line">          (<span class="name">m/return</span> (<span class="name">flood-fill</span> pixel colour state))))</span><br></pre></td></tr></table></figure>
<p><code>mlet</code> is analogous to do notation in Haskell. <code>valid-number-of-args</code>, <code>valid-pixel</code> and <code>valid-colour</code> are functions that return either a <code>Right</code> containing the value or a <code>Left</code> containing an error.</p>
<p>It’s probably clear that I could have used functions that throw an Exception with the error message, the above would then look like:</p>
<figure class="highlight clj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name"><span class="builtin-name">defn</span></span> valid-number-of-args</span><br><span class="line">  [args n]</span><br><span class="line">  (<span class="name"><span class="builtin-name">if</span></span> (<span class="name"><span class="builtin-name">=</span></span> n (<span class="name"><span class="builtin-name">count</span></span> args))</span><br><span class="line">    args</span><br><span class="line">    (<span class="name"><span class="builtin-name">throw</span></span> (<span class="name">Exception.</span> (<span class="name"><span class="builtin-name">str</span></span> <span class="string">"invalid number of arguments, expected "</span> n)))))</span><br><span class="line"></span><br><span class="line">(<span class="name"><span class="builtin-name">defmethod</span></span> do-command <span class="string">"F"</span></span><br><span class="line">  [_ state &amp; args]</span><br><span class="line">  (<span class="name"><span class="builtin-name">let</span></span> [[x y colour] (<span class="name">valid-number-of-args</span> args <span class="number">3</span>)</span><br><span class="line">        pixel (<span class="name">valid-pixel</span> state x y)</span><br><span class="line">        _ (<span class="name">valid-colour</span> colour)]</span><br><span class="line">        (<span class="name">flood-fill</span> pixel colour state)))</span><br></pre></td></tr></table></figure>
<p>You could argue that the second version, apart from being slightly more terse, is more idiomatic however I don’t believe this is true, Exceptions in Java were never intended to be used for unexceptional flow, it’s just that they have become commonly used in this way, precisely because they are basically a strange form of the Either monad, why not just use the real thing when dealing with non-exceptional flow? It also looks better if you can avoid instantiating java classes such as <code>Exception</code> in my opinion.</p>
<p>In this particular case the flow is not ‘exceptional’ at all since some of the commands such as ‘S’ which displays the current state on the console, should return a string even though there is no ‘error’. Having a function that always throws an <code>Exception</code> and yet is successful seems a bit dodgy to me. With <code>Either</code> you are not saying that <code>Left</code> are errors but rather that they are strings that should be displayed to the user.</p>
<p>I have also been using promises in the form of <a href="https://github.com/ztellman/manifold" target="_blank" rel="external">manifold</a> a lot recently and the semantics of this are almost exactly the same as <code>Either</code> and <code>mlet</code> above, a manifold <code>deferred</code> is essentially an async <code>Either</code>. Add to this that manifold can be used with cats and it adds up to a more consistent way of doing things. Everything looks the same, it’s just a matter of whether you want something to be async or not.</p>
<p>Finally, because an <code>Exception</code> will keep going up the call-chain until it is caught, it’s possible to introduce bugs where the <code>Execption</code> disappears into the ether, this can be a pain to discover sometimes. Using the <code>Either</code> semantics, Clojure’s type system will usually throw a runtime exception and problems will be slightly easier to spot.</p>
<p>My conclusion is that I like using <code>Either</code> in Clojure and I like cats :) I think I will use both in the future. It’s also nice to note that cats and some related libraries are moving Clojure in directions other than what the clojure.core team is doing. As clojure.core gets better and more innovative, the libraries and tools do as well. It makes me glad to be using Clojure and hopeful for it’s future.</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/04/27/beating-bugs-with-brute-force/" class="prev">NEXT</a><a href="/2014/09/09/static-vs-dynamic/" class="next">PREVIOUS</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://shmish111.github.io">David Smith</a>, unless otherwise noted.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-52255315-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>